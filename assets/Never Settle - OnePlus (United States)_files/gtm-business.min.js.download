(function(){var g=document.querySelectorAll.bind(document);var q=window.dataLayer=window.dataLayer||[];var j="";var h="";var a=10000;e();var o=window.gtmDebug;o&&(function(){console.log(q,h,j);var v=q.push;q.push=function(){v.apply(q,arguments);console.log(this)}})();document.addEventListener("DOMContentLoaded",function(){h=d();j=i();try{s()}catch(v){console.error(v)}});function s(){switch(j){case"home":b(q);break;case"store":t(q);break;case"phoneModels":u(q);break;case"accessoryDetail":m(q);break;case"jcart":f(q);break;case"paymentFail":k(q);break;case"paymentSuccess":p(q);break;case"checkout":c(q);break;default:break}}function c(y){var z;n(function(){return g(".r-product .detail").length>0},function(){var C=g(".r-product .detail");z=Array.prototype.map.call(C,function(D){var E=D.querySelector(".name").getAttribute("data-sku");return{id:E,name:D.querySelector(".name").textContent,price:Number(D.querySelector(".price").getAttribute("data-price")),category:B(E,D),quantity:Number(D.querySelector(".num").textContent)}});y.push({"event":"checkoutStep2-onePage","ecomm_prodid":z.map(function(D){return D.id}),"ecomm_category":z.map(function(D){return D.category}),"ecommerce":{"currencyCode":h,"checkout":{"actionField":{"step":2,"option":"One Page"},"products":z}}})},a);x();w();A();v();function x(){var D=g("#id-shipping-address .btn-continue")[0];var C="";D.addEventListener("click",function(){var E=g("#id-shipping-address [name=shipping]:checked");if(E){E=E[0];C=E.value==0?"adding":"choosing";y.push({"event":"checkoutStep3-shippingAddress","ecommerce":{"currencyCode":h,"checkout":{"actionField":{"step":3,"option":C},"products":z}}})}})}function w(){var C=g("#checkout-shipping-method-list .btn-continue")[0];C.addEventListener("click",function(){var D=g("#checkout-shipping-method-list [name=shipmethod]:checked");if(D){D=D[0];y.push({"event":"checkoutStep4-shippingMethod","ecommerce":{"currencyCode":h,"checkout":{"actionField":{"step":4,"option":D.getAttribute("data-name")},"products":z}}})}})}function A(){var C=g("#checkout-payment-method-list .btn-continue")[0];C.addEventListener("click",function(E){if(E.target.classList.contains("disabled")){return}var D=g("#checkout-payment-method-list [name=paymethod]:checked");if(D){D=D[0];y.push({"event":"checkoutStep5-paymentMethod","ecommerce":{"currencyCode":h,"checkout":{"actionField":{"step":5,"option":D.getAttribute("data-name")},"products":z}}})}})}function v(){var C=g("#btn-falcon-place-order")[0];C.addEventListener("click",function(E){var D=E.target.classList.contains("disabled");!D&&y.push({"event":"CheckoutStep6-placeOrder","ecommerce":{"currencyCode":h,"checkout":{"actionField":{"step":6,"option":"Place Order"},"products":z}}})})}function B(D,C){if(l(D)||C.nextElementSibling){return"Device"}else{if(C.classList.contains("b-insurance")){return"Insurance"}else{return C.querySelector(".b-buddle")?"Bundle":"Accessory"}}}}function p(w){var y=location.search.substring(1).split("&")[0].split("=")[1];n(function(){return g(".order-table tbody .row.core").length>0},function(){var D=g(".order-table tbody .row.core");var E=Array.prototype.map.call(D,function(I){var J=I.querySelector(".name").getAttribute("data-sku");return{id:J,accessories:Array.prototype.map.call(I.querySelectorAll(".package p.name"),function(K){return{id:K.getAttribute("data-sku")}}),name:I.querySelector(".name h4").textContent,category:x(J,I),price:Number(I.querySelector(".price .insure-num").getAttribute("data-price")),quantity:I.querySelector(".number").textContent.substring(1)}});var C=g(".row.core .sub-type");var G=Array.prototype.map.call(C,function(I){return{id:I.querySelector(".name").getAttribute("data-sku"),name:I.querySelector(".name p").textContent,price:Number(I.querySelector(".price .insure-num").getAttribute("data-price")),quantity:1,category:G}});E=E.concat(G);var H=E.map(function(I){return I.category});var F=(function B(I){return I.some(function(J){if(l(J.id)){return true}else{if(J.accessories&&J.accessories.length>0){return B(J.accessories)}}return false})})(E);var A=E.reduce(function(K,J){var L=0;if(l(J.id)){L=J.price}else{if(J.accessories&&J.accessories.length>0){var I=J.accessories.some(function(M){return l(M.id)});L=I?J.price:0}}return L+K},0);var z=E.reduce(function(J,I){return J+I.price*I.quantity},0);w.push({"ecomm_pagetype":"purchase","ecomm_prodid":E.map(function(I){return I.id}),"ecomm_value":z,"ecomm_category":H});w.push({"event":"Transaction","orderType":F?"device":"default","phoneSaleAmount":A,"accessorySaleAmount":(z-A).toFixed(2),"userEmail":g("#input-user-email-gtm")[0]&&g("#input-user-email-gtm")[0].value,"deliverCountry":g("#input-deliver-country-gtm")[0]&&g("#input-deliver-country-gtm")[0].value,"estimatedDeliveryDate":g("#input-estimated-delivery-date-gtm")[0]&&g("#input-estimated-delivery-date-gtm")[0].value,"ecommerce":{"currencyCode":h,"purchase":{"actionField":{"id":y,"affiliation":v("affiliation")||"","revenue":g("#input-revenue-gtm")[0]&&g("#input-revenue-gtm")[0].value,"tax":g("#input-tax-gtm")[0]&&g("#input-tax-gtm")[0].value,"shipping":g("#input-shipping-gtm")[0]&&g("#input-shipping-gtm")[0].value},"products":E.map(function(I){return{id:I.id,name:I.name,category:I.category,price:I.price,quantity:I.quantity}
})}}})},a);function v(z){var A="; "+document.cookie;var B=A.split("; "+z+"=");if(B.length==2){return B.pop().split(";").shift()}}function x(A,z){if(l(A)){return"Device"}else{return z.querySelector(".package p")?"Bundle":"Accessory"}}}function k(v){var w="";location.search.substring(1).split("&").some(function(x){if(x.split("=")[0]==="msg"){w=decodeURIComponent(x.split("=")[1]);return true}});v.push({"event":"transactionFailed","purchaseFailedReason":w})}function f(B){n(function(){return g(".cart-items .cart-item").length>0},function(){var F=w();var E=F.map(function(G){return G.category});B.push({"ecomm_pagetype":"cart","ecomm_value":F.reduce(function(H,G){return H+G.price*G.quantity},0),"ecomm_prodid":F.map(function(G){return G.id}),"ecomm_category":E});D();x();C()},a);function x(){var E=[{selector:".js-num-minus",action:"minus"},{selector:".js-num-add",action:"add"},{selector:".action-remove",action:"remove"}];g(".cart-items")[0].addEventListener("click",function(F){var G=F.target;E.forEach(function(H){if(G.matches(H.selector)){var I=G.classList.contains("disabled");if(!I){var J=r(G,".cart-item");z(H.action,J)}}})})}function z(G,E,H){if(E){var F=y(E);switch(G){case"add":F.quantity=H||1;B.push({"event":"cartIncrease","ecommerce":{"currencyCode":h,"add":{"products":[F]}}});break;case"minus":F.quantity=H||1;B.push({"event":"cartDecrease","ecommerce":{"currencyCode":h,"remove":{"products":[F]}}});break;case"remove":B.push({"event":"cartDelete","ecommerce":{"currencyCode":h,"remove":{"products":[F]}}});break;default:break}}}function D(){var E=g("#final_checkout")[0];E.addEventListener("click",function(){var F=this.href;try{var G=w();B.push({"event":"checkoutStep1-clickCheckout","ecommerce":{"currencyCode":h,"checkout":{"actionField":{"step":1,"option":"Click Checkout"},"products":G}},"eventCallback":function(){document.location=F},"eventTimeout":1000})}catch(H){document.location=F}})}function C(){var E=g(".like-goods-list .like-goods-box .btn-buy-recom, .cart-recommends .swiper-slide .btn-buy-recom");Array.prototype.forEach.call(E,function(F){F.addEventListener("click",function(I){var H=r(I.target,".like-goods-box");var J=H.querySelector("[data-sku]").getAttribute("data-sku");var G=Number(H.querySelector("[data-price]").getAttribute("data-price"));B.push({"event":"addProdToCart","ecomm_prodid":[J],"ecomm_value":G,"ecommerce":{"currencyCode":h,"add":{"products":[{id:J,name:H.querySelector(".info-name").textContent,price:G,quantity:1,dimension1:"In Stock"}]}}})})})}function w(){var G=g(".cart-items .cart-item");var E=Array.prototype.map.call(G,function(H){return y(H)});var F=A();return E.concat(F)}function A(){var E=g(".item-recom");return Array.prototype.map.call(E,function(F){return{id:F.getAttribute("data-sku"),name:F.querySelector(".recom-name").textContent,price:Number(F.querySelector(".recom-price .price").getAttribute("data-price")),category:"Insurance",quantity:Number(F.querySelector(".recom-qty input").value),dimension1:"In Stock"}})}function y(E){var F=E.getAttribute("data-sku");return{id:F,name:E.querySelector(".main-name a").textContent,price:Number(E.querySelector(".main-price .price").getAttribute("data-price")),category:v(F,E),quantity:Number(E.querySelector(".main-qty input").value),dimension1:E.querySelector(".main-name").hasAttribute("disabled")?"Out of Stock":"In Stock"}}function v(F,E){if(l(F)){return"Device"}else{if(E.querySelector(".item-recom")){return"Device"}else{return E.querySelector(".item-detail")?"Bundle":"Accessory"}}}}function u(E){n(function(){var G=Array.prototype.reduce.call(g(".sku-option .phone-info h6"),function(I,H){return I+(H&&H.textContent.trim()||"")},"");return G.length>0},function(){C()},a);var A=false;var F=false;function C(){var G=Array.prototype.map.call(g(".sku-option .as-phone-info"),function(I){return I});E.push({"event":"loadProductDetail","ecomm_prodid":G.map(function(I){return I.value}),"ecomm_pagetype":"product","ecommerce":{"currencyCode":h,"detail":{"products":G.map(function(I){return{id:I.value,name:I.getAttribute("data-name"),price:Number(I.getAttribute("data-price")),category:"Device",dimension1:I.disabled?"Out of Stock":"In Stock"}})}}});y();var H=g(".puppet.tab-nav-puppet")[0];H&&H.addEventListener("click",function(){F=false;setTimeout(function(){y()})})}function y(){var G=g(".sku-option .puppet.phone-puppet")||[];Array.prototype.forEach.call(G,function(H){H.addEventListener("click",function(I){var J=I.currentTarget.parentElement.querySelector("input");E.push({"event":"selectModel","model":J&&J.getAttribute("data-name")});setTimeout(function(){if(g("#tab-nav-insurance").length>0){B()}else{w()}})})})}function B(){var G=g(".btn-continue")||[];Array.prototype.forEach.call(G,function(H){H.addEventListener("click",function(){if(!F){setTimeout(function(){w()})}})})}function w(){if(!A){D();A=true}v();x();F=true}function D(){var G=g(".recoms .recom a");Array.prototype.forEach.call(G,function(H){H.addEventListener("click",function(){var L=this.getAttribute("data-sku");
var I=g(".recom-overlay[data-code="+L+"]")[0];if(I){var J=I.querySelector("[data-stock]");var K={id:I.getAttribute("data-code"),name:I.querySelector("h4.title").textContent,price:Number(I.getAttribute("data-price")),category:z(I),dimension1:J&&J.getAttribute("data-stock")==1?"In Stock":"Out of Stock"};E.push({"event":"popupAccessoryDetail","ecommerce":{"currencyCode":h,"detail":{"products":K}}})}})})}function v(){var G=g(".recom-overlay .btn-add-to-cart")||[];Array.prototype.forEach.call(G,function(H){H.addEventListener("click",function(J){var K=r(J.target,".right-container");var I=K&&K.querySelector(".title").textContent;E.push({"event":"addAccessory","model":I})})})}function x(){var G=g(".as-add-to-cart")||[];Array.prototype.forEach.call(G,function(H){H.addEventListener("click",function(){var I=document.getElementById("data-stats")&&JSON.parse(document.getElementById("data-stats").innerHTML)||null;var J=[];if(I){J=I.phone.list.map(function(K){return{id:K.sku,name:K.name,price:Number(K.discounted),category:"Device",quantity:1}});J=J.concat(I.recoms.list.map(function(K){return{id:K.sku,name:K.name,price:Number(K.discounted),category:z(g('[data-code="'+K.code+'"]')[0]),quantity:1}}));J=J.concat(I.insurance.list.map(function(K){return{id:K.sku,name:K.name,price:Number(K.discounted),category:"Insurance",quantity:1}}));E.push({"event":"addProdToCart","ecomm_value":J.reduce(function(L,K){return L+K.price},0),"ecomm_prodid":J.map(function(K){return K.id}),"ecommerce":{"currencyCode":h,"add":{"products":J}}})}})})}function z(H){if(!H){return""}var G="";if(H.querySelector(".simple-step")){G="Accessory"}else{if(H.querySelector(".series-steps")){G="Series"}else{if(H.querySelector(".bundle-steps")){G="Bundle"}}}return G}}function m(w){var z=document.getElementById("data-recom")&&JSON.parse(document.getElementById("data-recom").innerHTML)||null;var y=z&&(function(B){var A={};A.skus=[];if(B.simple){A.name=B.simple.name;A.category="Accessory";A.skus=A.skus.concat(B.simple.sku)}if(B.series&&B.series.skus){A.name=B.series.name;A.category="Series";A.skus=A.skus.concat(B.series.skus.map(function(C){return C.sku}))}if(B.bundle){A.skus=A.skus.concat(B.bundle.sku);A.name=B.bundle.name;A.category="Bundle"}return A})(z)||[];n(function(){return v()>0},function(){x()},a);function x(){var A=document.querySelector(".btn-add-to-cart");A&&A.addEventListener("click",function(){var C="";if(z&&z.simple){C=document.querySelector(".simple-step .behind-stage-input").value}else{C=document.querySelector(".sku-step .behind-stage-input:checked").value}var B=v();w.push({"event":"addProdToCart","ecomm_prodid":[C],"ecomm_value":B,"ecommerce":{"currencyCode":h,"add":{"products":[{"name":g(".recom-overlay h4.title")[0].textContent,"id":C,"price":B,"quantity":1,"category":y.category,"dimension1":"In Stock"}]}}})});w.push({"ecomm_pagetype":"accessory detail","ecomm_prodid":y.skus,"ecomm_value":v(),"ecomm_category":["Accessory"]});w.push({"event":"loadProductDetail","ecomm_prodid":y.skus,"ecommerce":{"currencyCode":h,"detail":{"products":(function(C){var B;if(C&&C.series){return Array.prototype.map.call(g(".behind-stage .behind-stage-input"),function(D){return{name:D.getAttribute("data-name"),id:D.getAttribute("data-sku"),price:D.getAttribute("data-price"),category:y.category,dimension1:D.getAttribute("data-stock")==1?"In Stock":"Out of Stock"}})}else{B=v();return{name:y.name,id:y.skus&&y.skus[0],price:B,category:y.category,dimension1:B.length>0?"In Stock":"Out of Stock"}}})(z)}}})}function v(){return Number(g(".recom-overlay")[0].getAttribute("data-price"))}}function b(x){var A=document.querySelector(".op-narrow-banner").querySelectorAll(".banner-column .banner-button, .banner-column .learn-more");var w=document.querySelector(".op-home-promo").querySelectorAll(".promo-item .item-link");var z=Array.prototype.filter.call(A,function(B){return B.innerText.trim()}).map(function(D){var B=D.getAttribute("promocr"),C=D.href,G=C+" | "+D.innerText,F=v(C);var E={id:G,name:F,creative:B,position:D.getAttribute("promops")};D.setAttribute("promonm",F);D.addEventListener("click",function(){x.push({"event":"promotionClick","ecommerce":{"promoClick":{"promotions":[E]}}})});return E});var y=Array.prototype.map.call(w,function(D){var B=D.getAttribute("promocr"),C=D.href,G=C+" | "+D.querySelector(".subtitle").innerText,F=v(C);var E={id:G,name:F,creative:B,position:D.getAttribute("promops")};D.setAttribute("promonm",F);D.addEventListener("click",function(){x.push({"event":"promotionClick","ecommerce":{"promoClick":{"promotions":[E]}}})});return E});x.push({"event":"loadHome","ecommerce":{"promoView":{"promotions":z.concat(y)}}});function v(C){var D=C.match(/https:\/\/(.*)\?.*/),B=D&&D[1].split("/").pop()||"";return B||C}}function t(x){var w=document.querySelector(".accessory-list-banner").querySelectorAll(".swiper-slide");var y=Array.prototype.filter.call(w,function(z){return !z.classList.contains("swiper-slide-duplicate")}).map(function(E){var B=E.querySelector(".link-clean");
var z=B.getAttribute("promocr"),A=B.href,F=A,D=v(A);var C={id:F,name:D,creative:z,position:B.getAttribute("promops")};B.setAttribute("promonm",D);B.addEventListener("click",function(){x.push({"event":"promotionClick","ecommerce":{"promoClick":{"promotions":[C]}}})});return C});x.push({"event":"loadProductList","ecommerce":{"promoView":{"promotions":y}}});function v(A){var B=A.match(/https:\/\/(.*)\?.*/),z=B&&B[1].split("/").pop()||"";return z||A}}function l(v){return v&&v.indexOf("501")===0}function i(){var w=location.pathname.split("/");var x=w.concat([]).pop();var v="";if(window.isHome){v="home"}else{if(x==="store"){v="store"}else{if(x==="jcart"){v="jcart"}else{if(x==="onepage"){v="checkout"}else{if(location.pathname.indexOf("jcart/falcon/success")>=0){v="paymentSuccess"}else{if(location.pathname.indexOf("sales/order/history")>=0&&location.search.indexOf("payment_status=error")>=0){v="paymentFail"}else{if(x.indexOf("oneplus-")===0&&document.getElementById("data-device")){v="phoneModels"}else{if(document.getElementById("data-recom")){v="accessoryDetail"}}}}}}}}return v}function d(){var v="";v=g("#footer .current-store")[0].textContent.match(/.*\(.*\/(.*)\).*/)[1].trim();return v}function e(){if(!Element.prototype.matches){Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(w){var x=(this.document||this.ownerDocument).querySelectorAll(w),v=x.length;while(--v>=0&&x.item(v)!==this){}return v>-1}}}function r(w,v){for(;w&&w!==document;w=w.parentNode){if(w.matches(v)){return w}}return null}function n(w,v,x){var z=Date.now();x=x||5000;var y=setInterval(function(){if(Date.now()-z>x||w()){v();clearInterval(y)}},100)}}());